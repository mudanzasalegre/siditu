<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>SIDITU: Formulario de Turnos de Celadores</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link th:href="@{/css/mystyle.css}" rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<style>
		/* Asegurarse de que los checkboxes estén alineados con el texto */
		.form-group .d-flex {
			align-items: center;
		}

		/* Aumentar el espacio entre el checkbox y la etiqueta */
		.form-check-input.me-2 {
			margin-right: 0.5rem;
		}

		/* Opcional: ajustar el tamaño del checkbox */
		.form-check-input {
			transform: scale(1.2);
			/* Aumenta el tamaño del checkbox para mayor visibilidad */
		}
	</style>
</head>

<body class="d-flex flex-column min-vh-100">
	<div class="container my-4 flex-grow-1">
		<h1 class="mb-4 text-center">SIDITU - Sistema de Distribución de Turnos</h1>
		<!-- Modal de advertencia -->
		<div class="modal fade" id="warningModal" tabindex="-1" aria-labelledby="warningModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header bg-warning text-dark">
						<h5 class="modal-title" id="warningModalLabel">Advertencia Importante</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<p>Recuerda que solo puedes generar la distribución de turnos una vez por turno. Asegúrate de
							reflejar la situación real del turno antes de enviar la generación de turnos.</p>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-primary" data-bs-dismiss="modal">Entendido</button>
					</div>
				</div>
			</div>
		</div>
		<!-- Mostrar el turno actual -->
		<div class="alert alert-info d-flex align-items-center"
			style="background-color: #e3f2fd; border-left: 5px solid #2196f3;">
			<div class="me-3">
				<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#2196f3" class="bi bi-clock"
					viewBox="0 0 16 16">
					<path d="M8 3.5a.5.5 0 0 1 .5.5v4.25l2.5 1.5a.5.5 0 1 1-.5.866L7.5 8.857V4a.5.5 0 0 1 .5-.5z" />
					<path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm0-1A7 7 0 1 1 8 1a7 7 0 0 1 0 14z" />
				</svg>
			</div>
			<div>
				<strong
					th:text="'Estamos en el turno de ' + (${turnoActual == 'M'} ? 'MAÑANA' : 'NOCHE') + ' del día ' + ${formattedDate}"></strong>
			</div>
		</div>
		<form id="formTurnos" action="/generarTurnos" method="post" onsubmit="return validateForm()">
			<div class="row mb-4">
				<label for="numeroDePersonas" class="col-sm-2 col-form-label">Número de Personas:</label>
				<div class="col-sm-1">
					<input type="number" id="numeroDePersonas" name="numeroDePersonas" required class="form-control"
						min="1" max="8" th:value="${numeroDePersonas}">
				</div>
			</div>
			<div id="nombreCampos" class="col-sm-6">
				<div th:each="nombre, iterStat : ${nombres}">
					<div class="form-group row mb-3 align-items-center">
						<label class="col-sm-3 col-form-label" th:for="'nombres[' + ${iterStat.index} + ']'">
							Nombre <span th:text="${iterStat.index + 1}"></span>:
						</label>
						<div class="col-sm-6">
							<input type="text" th:id="'nombres' + ${iterStat.index}"
								th:name="'nombres[' + ${iterStat.index} + ']'" th:value="${nombre}" class="form-control"
								required>
						</div>
						<div class="col-sm-3 d-flex align-items-center ms-3">
							<!-- Añadimos ms-3 para margen izquierdo -->
							<input type="checkbox" th:id="'puedeIrAQuirofano' + ${iterStat.index}"
								th:name="puedeIrAQuirofano" th:value="${iterStat.index}"
								th:checked="${puedeIrAQuirofano.contains(${iterStat.index})}"
								class="form-check-input me-2">
							<label class="form-check-label" th:for="'puedeIrAQuirofano' + ${iterStat.index}">Asignar a
								Q</label>
						</div>

					</div>

				</div>
			</div>

			<input type="hidden" name="turno" th:value="${turnoActual}">

			<hr>
			<div class="mb-3 form-check">
				<input type="checkbox" id="subdividir" name="subdividir" class="form-check-input"
					th:checked="${subdividir}">
				<label for="subdividir" class="form-check-label">Subdividir los turnos en mitades</label>
			</div>
			<hr>
			<div class="mb-3 form-check">
				<input type="checkbox" id="aleatorio" name="aleatorio" class="form-check-input"
					th:checked="${aleatorio}">
				<label for="aleatorio" class="form-check-label">Generar Turnos Aleatoriamente</label>
			</div>
			<button type="submit" class="btn btn-primary">Generar Turnos</button>
		</form>

	</div>

	<!-- Incluir el fragmento del footer -->
	<div th:replace="~{fragments/footer :: footer}"></div>


	<script>
		document.getElementById('numeroDePersonas').addEventListener('change', function () {
			const numeroDePersonas = parseInt(this.value);
			const container = document.getElementById('nombreCampos');

			// Obtener los valores actuales antes de borrar los campos
			const existingInputs = document.querySelectorAll('#nombreCampos .form-group input[type="text"]');
			const existingCheckboxes = document.querySelectorAll('#nombreCampos .form-group input[type="checkbox"]');

			let existingValues = Array.from(existingInputs).map(input => input.value);
			let existingCheckboxStates = Array.from(existingCheckboxes).map(checkbox => checkbox.checked);

			container.innerHTML = ''; // Limpiar los campos antiguos

			for (let i = 0; i < numeroDePersonas; i++) {
				const inputGroup = document.createElement('div');
				inputGroup.className = 'form-group row mb-3';

				const label = document.createElement('label');
				label.className = 'col-sm-3 col-form-label';
				label.textContent = 'Nombre ' + (i + 1) + ':';
				label.htmlFor = 'nombres[' + i + ']';

				const inputDiv = document.createElement('div');
				inputDiv.className = 'col-sm-6';

				const input = document.createElement('input');
				input.type = 'text';
				input.id = 'nombres' + i;
				input.name = 'nombres[]';
				input.required = true;
				input.className = 'form-control';

				// Si hay un valor existente para este campo, lo asignamos
				if (existingValues[i] !== undefined) {
					input.value = existingValues[i];
				}

				inputDiv.appendChild(input);

				const checkboxDiv = document.createElement('div');
				checkboxDiv.className = 'col-sm-3 form-check';

				const checkbox = document.createElement('input');
				checkbox.type = 'checkbox';
				checkbox.id = 'puedeIrAQuirofano' + i;
				checkbox.name = 'puedeIrAQuirofano';
				checkbox.value = i;
				checkbox.className = 'form-check-input';

				const checkboxLabel = document.createElement('label');
				checkboxLabel.className = 'form-check-label';
				checkboxLabel.htmlFor = 'puedeIrAQuirofano' + i;
				checkboxLabel.textContent = 'Asignar a Q';

				// Si hay un estado existente para este checkbox, lo asignamos
				if (existingCheckboxStates[i] !== undefined) {
					checkbox.checked = existingCheckboxStates[i];
				}

				checkboxDiv.appendChild(checkbox);
				checkboxDiv.appendChild(checkboxLabel);

				inputGroup.appendChild(label);
				inputGroup.appendChild(inputDiv);
				inputGroup.appendChild(checkboxDiv);

				container.appendChild(inputGroup);
			}
		});



		function validateForm() {
			const inputs = document.querySelectorAll('#nombreCampos input[type="text"]');
			const checkboxes = document.querySelectorAll('#nombreCampos input[type="checkbox"]:checked');

			if (inputs.length < 5) {
				Swal.fire({
					icon: 'error',
					title: 'Error',
					text: 'Debe haber al menos 5 empleados para distribuir el turno.',
				});
				return false;
			}

			if (checkboxes.length === 0) {
				Swal.fire({
					icon: 'error',
					title: 'Error',
					text: 'Debe seleccionar al menos un empleado que pueda ir a quirófano.',
				});
				return false;
			}

			for (let input of inputs) {
				if (input.value.trim() === '') {
					Swal.fire({
						icon: 'error',
						title: 'Error',
						text: 'Por favor, completa todos los campos de nombre.',
					});
					return false;
				}
			}

			return true;
		}


		// Mostrar el modal cuando la página se carga
		window.addEventListener('load', function () {
			var warningModal = new bootstrap.Modal(document.getElementById('warningModal'));
			warningModal.show();
		});
	</script>
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
		integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
		crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
		integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
		crossorigin="anonymous"></script>
</body>

</html>